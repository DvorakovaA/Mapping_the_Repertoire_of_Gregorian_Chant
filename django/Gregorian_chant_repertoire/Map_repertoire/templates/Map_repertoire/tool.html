{% extends "base.html" %}



{% block content %}
<div class="container ms-4 mt-3 border border-secondary rounded">
  <h3>Request form</h3> <br>
  <form method="post">
      {% csrf_token %}
      <div id="feastSelection">
        <label for="{{ form.feast.id_for_label }}">Feast:</label>
        <div class="ms-3">
          {{ form.feast }}
        </div>
      </div>
      <br>
      <div id="allSelection">
        <label for="id_all">Select complete repertoire for feast:</label>
        <div class="ms-3">
          {{ form.all }}
        </div>
      </div>
      <div id="officeSelection">
        <label for="{{ form.office.id_for_label }}">or select only particular office:</label>
        <div class="ms-3">
          {{ form.office }}
        </div>
      </div>
      <br>
      <div id="algoSelection">
        <label for="{{ form.community_detection_algorithm.id_for_label }}">Community detection algorithm:</label>
        <div class="ms-3">
          {{ form.community_detection_algorithm }}
        </div>
      </div>
      <br>
      <div id="metricSelection">
        <label for="{{ form.metric.id_for_label }}">Metric:</label>
        <div class="ms-3">
          {{ form.metric }}
        </div>
      </div>
      <div id="numberOfTopicsSelection">
        <label for="{{ form.number_of_topics.id_for_label }}">Number of topics:</label>
        <div class="ms-3">
          {{ form.number_of_topics }}
        </div>
      </div>
      <br>
      <input type="submit" value="Show" class="btn btn-outline-secondary">
  </form> 
  <br>
</div>
{% endblock %}


{% block result %}
  <div class="container ms-4">
    <br><br>
    <h4> Selected feasts: </h4> 
    <h5>
      <div class="ms-3">
        {% for feast in feasts %} 
          {{ feast }} <br>
        {% endfor %}
      </div>
    </h5>
    <h4> Significance level: {{ sig_level }} </h4> <br>
  </div>

  <div class="container ms-4 mb-3">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" id="myTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="table-tab-btn" data-bs-toggle="tab" data-bs-target="#table" type="button" role="tab">Table view</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="com-map-tab-btn" data-bs-toggle="tab" data-bs-target="#community" type="button" role="tab">Community map view</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="cen-map-tab-btn" data-bs-toggle="tab" data-bs-target="#century" type="button" role="tab">Century map view</button>
      </li>
    </ul>
        
    <!-- Tab panes -->
    <div class="tab-content">
      <div id="table" class="tab-pane fade show active" role="tabpanel">
        <br>
        {% if tab_data %}
          <button type="button" href="#/" class="btn btn-outline-secondary btn-sm"  data-collapsible-expand-all>Show all</button>
          <button type="button" href="#/" class="btn btn-outline-secondary btn-sm"  data-collapsible-collapse-all>Hide all</button>
          <br>

          <table class="mainTable" border='1'>
            <tbody>
              <tr>
                <th bgcolor="grey"></th>
                {% for com in tab_data.head %}
                  <th bgcolor={{com.color}} style="color:white;"> {{ com.com }} <br> {{ com.sources }} </th>
                {% endfor %}
              </tr>

              {% for office, office_chants in tab_data.body.items %}
                <tr>
                  <td> <b> {{ office }} </b> </td>
                    <!-- iteration over cells -->
                    {% for com_chants_dicts in office_chants %} 
                      <td data-collapsible-container>
                        <table>      
                            {% for uncoll_chant in com_chants_dicts.uncollapsed %}
                              <tr>
                                {{ uncoll_chant.incipit }}
                                <a href='http://www.cantusindex.org/id/{{ uncoll_chant.cantus_id }}'  target="_blank" rel="noopener noreferrer">{{ uncoll_chant.cantus_id }}</a> {{ uncoll_chant.freq }} <br>
                              </tr>
                            {% endfor %}
                        </table>
                        {% if com_chants_dicts.collapsed %}
                          <div data-collapsible class="collapsible collapsed">
                            <div class="collapsible-inner">
                              <table>
                                {% for coll_chant in com_chants_dicts.collapsed %}
                                <tr>
                                  {{ coll_chant.incipit }}
                                  <a href='http://www.cantusindex.org/id/{{ coll_chant.cantus_id }}'  target="_blank" rel="noopener noreferrer">{{ coll_chant.cantus_id }}</a> {{ coll_chant.freq }} <br>
                                </tr>
                              {% endfor %}
                              </table>
                            </div>
                          </div>
                          <a href="#/" data-collapsible-trigger>Show more</a>
                        {% endif %}
                      </td>
                    {% endfor %}
                </tr>
              {% endfor %}
          
            <tr>
              {% if tab_data.tail %}
                <td>Sources</td>
                  {% for com in tab_data.tail %}
                      <td> 
                        {% for s in com %}
                        <a href='{{ s.source_id }}'  target="_blank" rel="noopener noreferrer">{{ s.siglum }}</a> <br>
                        {% endfor %}
                      </td>
                  {% endfor %}
              {% endif %}
            </tr>
          
            </tbody>
          </table>

        {% else %}
          <h3> No data for given request </h3>
        {% endif %}
      </div>

      <div id="community" class="tab-pane fade" role="tabpanel">
        {% if map_data.no_prov_sources %}
          <div id="missing_provenance" class="mt-3 mb-3">
            <h5> Sourses with unknown provenances: </h5>
            <div class="ms-3">
              {% for source in map_data.no_prov_sources %}
                <a href='{{ source }}'  target="_blank" rel="noopener noreferrer">{{ source }}</a> <br>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <container class="mt-1 mb-0">
          <p style="float: right;"> △ - Secular | ▢ - Monastic | 〇 - unknown </p>
        </container>

        <div id="com_map" class="mb-3 mt-1"></div>
      </div>

      <div id="century" class="tab-pane fade" role="tabpanel">
        {% if map_data.no_prov_sources %}
          <div id="missing_provenance" class="mt-3 mb-3">
            <h5> Sourses with unknown provenances: </h5>
            <div class="ms-3">
              {% for source in map_data.no_prov_sources %}
                <a href='{{ source }}'  target="_blank" rel="noopener noreferrer">{{ source }}</a> <br>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <container class="mt-3 mb-0">
          <p style="float: right;"> △ - Secular | ▢ - Monastic | 〇 - unknown </p>
        </container>

        <div id="cen_map" class="mb-3 mt-1"></div>
      </div>
    </div>

  </div>

  <!-- pass data from djnago context to js script part -->
  {{ map_data|json_script:"map_data" }}
  <script>
    // Get results maps
    const map_data = JSON.parse(document.getElementById('map_data').textContent);
    var maps = getMaps(map_data); 
    var com_map = maps.com_map; 
    var cen_map = maps.cen_map;

    // Ensure map in tab is ready to be displayed
    var comTab = document.getElementById('com-map-tab-btn');
    comTab.addEventListener("shown.bs.tab", function (e) {
        com_map.invalidateSize();
    })
    var cenTab = document.getElementById('cen-map-tab-btn');
    cenTab.addEventListener("shown.bs.tab", function (e) {
        cen_map.invalidateSize();
    })
    

    // Dynamic changes in displaying form
    // Louvein      
    var Louvein_checked = document.getElementById('id_community_detection_algorithm_0');
    Louvein_checked.addEventListener('click', function() {
            document.getElementById('metricSelection').style.display = 'inline';
            document.getElementById('numberOfTopicsSelection').style.display = 'none';
    })
    // DBSCAN
    var DBSCAN_checked = document.getElementById('id_community_detection_algorithm_1');
    DBSCAN_checked.addEventListener('click', function() {
            document.getElementById('metricSelection').style.display = 'inline';
            document.getElementById('numberOfTopicsSelection').style.display = 'none';
    })
    // Topic model
    var Topic_checked = document.getElementById('id_community_detection_algorithm_2');
    Topic_checked.addEventListener('click', function() { 
        document.getElementById('metricSelection').style.display = 'none';
        document.getElementById('numberOfTopicsSelection').style.display = 'inline';
    });
    // to preserve choices after Show (refresh)
    if (document.getElementById('id_community_detection_algorithm_2').checked) {
        document.getElementById('metricSelection').style.display = 'none';
        document.getElementById('numberOfTopicsSelection').style.display = 'inline'
    }

    // Set All options as checked as default
    if (!document.getElementById('id_office_0').checked & !document.getElementById('id_office_1').checked
        & !document.getElementById('id_office_2').checked & !document.getElementById('id_office_3').checked) 
        {
          document.getElementById('id_all_0').checked = true;
        }
    // Dynamic check and uncheck of office selection
    var allChcekbox = document.getElementById('id_all_0');
    allChcekbox.addEventListener('click', function() {
      document.getElementById('id_office_0').checked = false;
      document.getElementById('id_office_1').checked = false;
      document.getElementById('id_office_2').checked = false;
      document.getElementById('id_office_3').checked = false;
    });
    var VChcekbox = document.getElementById('id_office_0');
    VChcekbox.addEventListener('click', function() {
      document.getElementById('id_all_0').checked = false;
    });
    var MChcekbox = document.getElementById('id_office_1');
    MChcekbox.addEventListener('click', function() {
      document.getElementById('id_all_0').checked = false;
    });
    var LChcekbox = document.getElementById('id_office_2');
    LChcekbox.addEventListener('click', function() {
      document.getElementById('id_all_0').checked = false;
    });
    var V2Chcekbox = document.getElementById('id_office_3');
    V2Chcekbox.addEventListener('click', function() {
      document.getElementById('id_all_0').checked = false;
    });


    // Toggle parts of table view
    document.addEventListener('DOMContentLoaded', function () {
    var mainTable = document.getElementsByClassName('mainTable')[0];
    
    // Get all elements with data-collapsible-trigger attribute
    var triggerElements = mainTable.querySelectorAll('[data-collapsible-trigger]');

    // Iterate through each trigger element
    triggerElements.forEach(function (trigger) {
        // Add click event listener to each trigger
        trigger.addEventListener('click', function () {
            // Find the closest parent with data-collapsible-container attribute
            var container = this.closest('[data-collapsible-container]');

            // Find the collapsible element within the container
            var collapsible = container.querySelector('[data-collapsible]');

            // Toggle the collapsed class on the collapsible element
            collapsible.classList.toggle('collapsed');

            // Toggle the text content of the trigger
            var triggerText = collapsible.classList.contains('collapsed') ? 'Show more' : 'Hide';
            this.textContent = triggerText;
        });
    });

    var expandAllTrigger = document.querySelectorAll('[data-collapsible-expand-all]');
    expandAllTrigger.forEach(function (trigger) {
        trigger.addEventListener('click', function () {
        var collabsibleContainers = mainTable.querySelectorAll('[data-collapsible-container]');
        collabsibleContainers.forEach(function (container) {
            var collapsibleElements = container.querySelectorAll('[data-collapsible]');
            collapsibleElements.forEach(function (collapsibleEl) {
            collapsibleEl.classList.remove('collapsed');
            });
            var collapsibleTriggers = container.querySelectorAll('[data-collapsible-trigger]');
            collapsibleTriggers.forEach(function (triggerEl) {
            triggerEl.textContent = 'Hide';
            });
        });
        });
    });

    var collapseAllTrigger = document.querySelectorAll('[data-collapsible-collapse-all]');
    collapseAllTrigger.forEach(function (trigger) {
        trigger.addEventListener('click', function () {
        var collabsibleContainers = mainTable.querySelectorAll('[data-collapsible-container]');
        collabsibleContainers.forEach(function (container) {
            var collapsibleElements = container.querySelectorAll('[data-collapsible]');
            collapsibleElements.forEach(function (collapsibleEl) {
            collapsibleEl.classList.add('collapsed');
            });
            var collapsibleTriggers = container.querySelectorAll('[data-collapsible-trigger]');
            collapsibleTriggers.forEach(function (triggerEl) {
            triggerEl.textContent = 'Show more';
            });
          });
        });
      });
    });

  </script>

      
{% endblock %}